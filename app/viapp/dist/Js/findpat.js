/*
*
* Copyright 2007 ZXing authors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
var MIN_SKIP=3;var MAX_MODULES=57;var INTEGER_MATH_SHIFT=8;var CENTER_QUORUM=2;qrcode.orderBestPatterns=function(t){function e(t,e){var r=t.X-e.X;var i=t.Y-e.Y;return Math.sqrt(r*r+i*i)}function r(t,e,r){var i=e.x;var s=e.y;return(r.x-i)*(t.y-s)-(r.y-s)*(t.x-i)}var i=e(t[0],t[1]);var s=e(t[1],t[2]);var n=e(t[0],t[2]);var a,o,h;if(s>=i&&s>=n){o=t[0];a=t[1];h=t[2]}else if(n>=s&&n>=i){o=t[1];a=t[0];h=t[2]}else{o=t[2];a=t[0];h=t[1]}if(r(a,o,h)<0){var u=a;a=h;h=u}t[0]=a;t[1]=o;t[2]=h};function FinderPattern(t,e,r){this.x=t;this.y=e;this.count=1;this.estimatedModuleSize=r;this.__defineGetter__("EstimatedModuleSize",function(){return this.estimatedModuleSize});this.__defineGetter__("Count",function(){return this.count});this.__defineGetter__("X",function(){return this.x});this.__defineGetter__("Y",function(){return this.y});this.incrementCount=function(){this.count++};this.aboutEquals=function(t,e,r){if(Math.abs(e-this.y)<=t&&Math.abs(r-this.x)<=t){var i=Math.abs(t-this.estimatedModuleSize);return i<=1||i/this.estimatedModuleSize<=1}return false}}function FinderPatternInfo(t){this.bottomLeft=t[0];this.topLeft=t[1];this.topRight=t[2];this.__defineGetter__("BottomLeft",function(){return this.bottomLeft});this.__defineGetter__("TopLeft",function(){return this.topLeft});this.__defineGetter__("TopRight",function(){return this.topRight})}function FinderPatternFinder(){this.image=null;this.possibleCenters=[];this.hasSkipped=false;this.crossCheckStateCount=new Array(0,0,0,0,0);this.resultPointCallback=null;this.__defineGetter__("CrossCheckStateCount",function(){this.crossCheckStateCount[0]=0;this.crossCheckStateCount[1]=0;this.crossCheckStateCount[2]=0;this.crossCheckStateCount[3]=0;this.crossCheckStateCount[4]=0;return this.crossCheckStateCount});this.foundPatternCross=function(t){var e=0;for(var r=0;r<5;r++){var i=t[r];if(i==0){return false}e+=i}if(e<7){return false}var s=Math.floor((e<<INTEGER_MATH_SHIFT)/7);var n=Math.floor(s/2);return Math.abs(s-(t[0]<<INTEGER_MATH_SHIFT))<n&&Math.abs(s-(t[1]<<INTEGER_MATH_SHIFT))<n&&Math.abs(3*s-(t[2]<<INTEGER_MATH_SHIFT))<3*n&&Math.abs(s-(t[3]<<INTEGER_MATH_SHIFT))<n&&Math.abs(s-(t[4]<<INTEGER_MATH_SHIFT))<n};this.centerFromEnd=function(t,e){return e-t[4]-t[3]-t[2]/2};this.crossCheckVertical=function(t,e,r,i){var s=this.image;var n=qrcode.height;var a=this.CrossCheckStateCount;var o=t;while(o>=0&&s[e+o*qrcode.width]){a[2]++;o--}if(o<0){return NaN}while(o>=0&&!s[e+o*qrcode.width]&&a[1]<=r){a[1]++;o--}if(o<0||a[1]>r){return NaN}while(o>=0&&s[e+o*qrcode.width]&&a[0]<=r){a[0]++;o--}if(a[0]>r){return NaN}o=t+1;while(o<n&&s[e+o*qrcode.width]){a[2]++;o++}if(o==n){return NaN}while(o<n&&!s[e+o*qrcode.width]&&a[3]<r){a[3]++;o++}if(o==n||a[3]>=r){return NaN}while(o<n&&s[e+o*qrcode.width]&&a[4]<r){a[4]++;o++}if(a[4]>=r){return NaN}var h=a[0]+a[1]+a[2]+a[3]+a[4];if(5*Math.abs(h-i)>=2*i){return NaN}return this.foundPatternCross(a)?this.centerFromEnd(a,o):NaN};this.crossCheckHorizontal=function(t,e,r,i){var s=this.image;var n=qrcode.width;var a=this.CrossCheckStateCount;var o=t;while(o>=0&&s[o+e*qrcode.width]){a[2]++;o--}if(o<0){return NaN}while(o>=0&&!s[o+e*qrcode.width]&&a[1]<=r){a[1]++;o--}if(o<0||a[1]>r){return NaN}while(o>=0&&s[o+e*qrcode.width]&&a[0]<=r){a[0]++;o--}if(a[0]>r){return NaN}o=t+1;while(o<n&&s[o+e*qrcode.width]){a[2]++;o++}if(o==n){return NaN}while(o<n&&!s[o+e*qrcode.width]&&a[3]<r){a[3]++;o++}if(o==n||a[3]>=r){return NaN}while(o<n&&s[o+e*qrcode.width]&&a[4]<r){a[4]++;o++}if(a[4]>=r){return NaN}var h=a[0]+a[1]+a[2]+a[3]+a[4];if(5*Math.abs(h-i)>=i){return NaN}return this.foundPatternCross(a)?this.centerFromEnd(a,o):NaN};this.handlePossibleCenter=function(t,e,r){var i=t[0]+t[1]+t[2]+t[3]+t[4];var s=this.centerFromEnd(t,r);var n=this.crossCheckVertical(e,Math.floor(s),t[2],i);if(!isNaN(n)){s=this.crossCheckHorizontal(Math.floor(s),Math.floor(n),t[2],i);if(!isNaN(s)){var a=i/7;var o=false;var h=this.possibleCenters.length;for(var u=0;u<h;u++){var f=this.possibleCenters[u];if(f.aboutEquals(a,n,s)){f.incrementCount();o=true;break}}if(!o){var l=new FinderPattern(s,n,a);this.possibleCenters.push(l);if(this.resultPointCallback!=null){this.resultPointCallback.foundPossibleResultPoint(l)}}return true}}return false};this.selectBestPatterns=function(){var t=this.possibleCenters.length;if(t<3){throw"Couldn't find enough finder patterns (found "+t+")"}if(t>3){var e=0;var r=0;for(var i=0;i<t;i++){var s=this.possibleCenters[i].EstimatedModuleSize;e+=s;r+=s*s}var n=e/t;this.possibleCenters.sort(function(t,e){var r=Math.abs(e.EstimatedModuleSize-n);var i=Math.abs(t.EstimatedModuleSize-n);if(r<i){return-1}else if(r==i){return 0}else{return 1}});var a=Math.sqrt(r/t-n*n);var o=Math.max(.2*n,a);for(var i=this.possibleCenters.length-1;i>=0;i--){var h=this.possibleCenters[i];if(Math.abs(h.EstimatedModuleSize-n)>o){this.possibleCenters.splice(i,1)}}}if(this.possibleCenters.length>3){this.possibleCenters.sort(function(t,e){if(t.count>e.count){return-1}if(t.count<e.count){return 1}return 0})}return new Array(this.possibleCenters[0],this.possibleCenters[1],this.possibleCenters[2])};this.findRowSkip=function(){var t=this.possibleCenters.length;if(t<=1){return 0}var e=null;for(var r=0;r<t;r++){var i=this.possibleCenters[r];if(i.Count>=CENTER_QUORUM){if(e==null){e=i}else{this.hasSkipped=true;return Math.floor((Math.abs(e.X-i.X)-Math.abs(e.Y-i.Y))/2)}}}return 0};this.haveMultiplyConfirmedCenters=function(){var t=0;var e=0;var r=this.possibleCenters.length;for(var i=0;i<r;i++){var s=this.possibleCenters[i];if(s.Count>=CENTER_QUORUM){t++;e+=s.EstimatedModuleSize}}if(t<3){return false}var n=e/r;var a=0;for(var i=0;i<r;i++){s=this.possibleCenters[i];a+=Math.abs(s.EstimatedModuleSize-n)}return a<=.05*e};this.findFinderPattern=function(t){var e=false;this.image=t;var r=qrcode.height;var i=qrcode.width;var s=Math.floor(3*r/(4*MAX_MODULES));if(s<MIN_SKIP||e){s=MIN_SKIP}var n=false;var a=new Array(5);for(var o=s-1;o<r&&!n;o+=s){a[0]=0;a[1]=0;a[2]=0;a[3]=0;a[4]=0;var h=0;for(var u=0;u<i;u++){if(t[u+o*qrcode.width]){if((h&1)==1){h++}a[h]++}else{if((h&1)==0){if(h==4){if(this.foundPatternCross(a)){var f=this.handlePossibleCenter(a,o,u);if(f){s=2;if(this.hasSkipped){n=this.haveMultiplyConfirmedCenters()}else{var l=this.findRowSkip();if(l>a[2]){o+=l-a[2]-s;u=i-1}}}else{do{u++}while(u<i&&!t[u+o*qrcode.width]);u--}h=0;a[0]=0;a[1]=0;a[2]=0;a[3]=0;a[4]=0}else{a[0]=a[2];a[1]=a[3];a[2]=a[4];a[3]=1;a[4]=0;h=3}}else{a[++h]++}}else{a[h]++}}}if(this.foundPatternCross(a)){var f=this.handlePossibleCenter(a,o,i);if(f){s=a[0];if(this.hasSkipped){n=this.haveMultiplyConfirmedCenters()}}}}var d=this.selectBestPatterns();qrcode.orderBestPatterns(d);return new FinderPatternInfo(d)}}
//# sourceMappingURL=findpat.js.map