/*
*
* Copyright 2007 ZXing authors
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*      http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
function PerspectiveTransform(a,t,i,r,s,e,h,n,o){this.a11=a;this.a12=r;this.a13=h;this.a21=t;this.a22=s;this.a23=n;this.a31=i;this.a32=e;this.a33=o;this.transformPoints1=function(a){var t=a.length;var i=this.a11;var r=this.a12;var s=this.a13;var e=this.a21;var h=this.a22;var n=this.a23;var o=this.a31;var v=this.a32;var l=this.a33;for(var u=0;u<t;u+=2){var f=a[u];var c=a[u+1];var d=s*f+n*c+l;a[u]=(i*f+e*c+o)/d;a[u+1]=(r*f+h*c+v)/d}};this.transformPoints2=function(a,t){var i=a.length;for(var r=0;r<i;r++){var s=a[r];var e=t[r];var h=this.a13*s+this.a23*e+this.a33;a[r]=(this.a11*s+this.a21*e+this.a31)/h;t[r]=(this.a12*s+this.a22*e+this.a32)/h}};this.buildAdjoint=function(){return new PerspectiveTransform(this.a22*this.a33-this.a23*this.a32,this.a23*this.a31-this.a21*this.a33,this.a21*this.a32-this.a22*this.a31,this.a13*this.a32-this.a12*this.a33,this.a11*this.a33-this.a13*this.a31,this.a12*this.a31-this.a11*this.a32,this.a12*this.a23-this.a13*this.a22,this.a13*this.a21-this.a11*this.a23,this.a11*this.a22-this.a12*this.a21)};this.times=function(a){return new PerspectiveTransform(this.a11*a.a11+this.a21*a.a12+this.a31*a.a13,this.a11*a.a21+this.a21*a.a22+this.a31*a.a23,this.a11*a.a31+this.a21*a.a32+this.a31*a.a33,this.a12*a.a11+this.a22*a.a12+this.a32*a.a13,this.a12*a.a21+this.a22*a.a22+this.a32*a.a23,this.a12*a.a31+this.a22*a.a32+this.a32*a.a33,this.a13*a.a11+this.a23*a.a12+this.a33*a.a13,this.a13*a.a21+this.a23*a.a22+this.a33*a.a23,this.a13*a.a31+this.a23*a.a32+this.a33*a.a33)}}PerspectiveTransform.quadrilateralToQuadrilateral=function(a,t,i,r,s,e,h,n,o,v,l,u,f,c,d,m){var M=this.quadrilateralToSquare(a,t,i,r,s,e,h,n);var q=this.squareToQuadrilateral(o,v,l,u,f,c,d,m);return q.times(M)};PerspectiveTransform.squareToQuadrilateral=function(a,t,i,r,s,e,h,n){var o=n-e;var v=t-r+e-n;if(o==0&&v==0){return new PerspectiveTransform(i-a,s-i,a,r-t,e-r,t,0,0,1)}else{var l=i-s;var u=h-s;var f=a-i+s-h;var c=r-e;var d=l*o-u*c;var m=(f*o-u*v)/d;var M=(l*v-f*c)/d;return new PerspectiveTransform(i-a+m*i,h-a+M*h,a,r-t+m*r,n-t+M*n,t,m,M,1)}};PerspectiveTransform.quadrilateralToSquare=function(a,t,i,r,s,e,h,n){return this.squareToQuadrilateral(a,t,i,r,s,e,h,n).buildAdjoint()};function DetectorResult(a,t){this.bits=a;this.points=t}function Detector(a){this.image=a;this.resultPointCallback=null;this.sizeOfBlackWhiteBlackRun=function(a,t,i,r){var s=Math.abs(r-t)>Math.abs(i-a);if(s){var e=a;a=t;t=e;e=i;i=r;r=e}var h=Math.abs(i-a);var n=Math.abs(r-t);var o=-h>>1;var v=t<r?1:-1;var l=a<i?1:-1;var u=0;for(var f=a,c=t;f!=i;f+=l){var d=s?c:f;var m=s?f:c;if(u==1){if(this.image[d+m*qrcode.width]){u++}}else{if(!this.image[d+m*qrcode.width]){u++}}if(u==3){var M=f-a;var q=c-t;return Math.sqrt(M*M+q*q)}o+=n;if(o>0){if(c==r){break}c+=v;o-=h}}var g=i-a;var p=r-t;return Math.sqrt(g*g+p*p)};this.sizeOfBlackWhiteBlackRunBothWays=function(a,t,i,r){var s=this.sizeOfBlackWhiteBlackRun(a,t,i,r);var e=1;var h=a-(i-a);if(h<0){e=a/(a-h);h=0}else if(h>=qrcode.width){e=(qrcode.width-1-a)/(h-a);h=qrcode.width-1}var n=Math.floor(t-(r-t)*e);e=1;if(n<0){e=t/(t-n);n=0}else if(n>=qrcode.height){e=(qrcode.height-1-t)/(n-t);n=qrcode.height-1}h=Math.floor(a+(h-a)*e);s+=this.sizeOfBlackWhiteBlackRun(a,t,h,n);return s-1};this.calculateModuleSizeOneWay=function(a,t){var i=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(a.X),Math.floor(a.Y),Math.floor(t.X),Math.floor(t.Y));var r=this.sizeOfBlackWhiteBlackRunBothWays(Math.floor(t.X),Math.floor(t.Y),Math.floor(a.X),Math.floor(a.Y));if(isNaN(i)){return r/7}if(isNaN(r)){return i/7}return(i+r)/14};this.calculateModuleSize=function(a,t,i){return(this.calculateModuleSizeOneWay(a,t)+this.calculateModuleSizeOneWay(a,i))/2};this.distance=function(a,t){var i=a.X-t.X;var r=a.Y-t.Y;return Math.sqrt(i*i+r*r)};this.computeDimension=function(a,t,i,r){var s=Math.round(this.distance(a,t)/r);var e=Math.round(this.distance(a,i)/r);var h=(s+e>>1)+7;switch(h&3){case 0:h++;break;case 2:h--;break;case 3:throw"Error"}return h};this.findAlignmentInRegion=function(a,t,i,r){var s=Math.floor(r*a);var e=Math.max(0,t-s);var h=Math.min(qrcode.width-1,t+s);if(h-e<a*3){throw"Error"}var n=Math.max(0,i-s);var o=Math.min(qrcode.height-1,i+s);var v=new AlignmentPatternFinder(this.image,e,n,h-e,o-n,a,this.resultPointCallback);return v.find()};this.createTransform=function(a,t,i,r,s){var e=s-3.5;var h;var n;var o;var v;if(r!=null){h=r.X;n=r.Y;o=v=e-3}else{h=t.X-a.X+i.X;n=t.Y-a.Y+i.Y;o=v=e}var l=PerspectiveTransform.quadrilateralToQuadrilateral(3.5,3.5,e,3.5,o,v,3.5,e,a.X,a.Y,t.X,t.Y,h,n,i.X,i.Y);return l};this.sampleGrid=function(a,t,i){var r=GridSampler;return r.sampleGrid3(a,i,t)};this.processFinderPatternInfo=function(a){var t=a.TopLeft;var i=a.TopRight;var r=a.BottomLeft;var s=this.calculateModuleSize(t,i,r);if(s<1){throw"Error"}var e=this.computeDimension(t,i,r,s);var h=Version.getProvisionalVersionForDimension(e);var n=h.DimensionForVersion-7;var o=null;if(h.AlignmentPatternCenters.length>0){var v=i.X-t.X+r.X;var l=i.Y-t.Y+r.Y;var u=1-3/n;var f=Math.floor(t.X+u*(v-t.X));var c=Math.floor(t.Y+u*(l-t.Y));for(var d=4;d<=16;d<<=1){o=this.findAlignmentInRegion(s,f,c,d);break}}var m=this.createTransform(t,i,r,o,e);var M=this.sampleGrid(this.image,m,e);var q;if(o==null){q=new Array(r,t,i)}else{q=new Array(r,t,i,o)}return new DetectorResult(M,q)};this.detect=function(){var a=(new FinderPatternFinder).findFinderPattern(this.image);return this.processFinderPatternInfo(a)}}
//# sourceMappingURL=detector.js.map